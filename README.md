Superflux
=========

Superflux is an event listener for [Supervisor][supervisor] that sends events as generated
by Supervisor to [InfluxDB][influxdb].

The idea behind this project is that events like restarts and backing off a continuously
failing process may be recorded in the local logfile, but they'd be far more useful if
overlayed with your other data like CPU usage, request per second increase or
any other resource change.

Superflux uses the [Supervisor Events Framework][supervisor_events] and can listen and
understand any events emitted.

Installing Superflux
--------------------

To install Superflux, you can either clone this repository and run the install script:

```
$ git clone git@github.com:arquivei/superflux.git
$ cd superflux
$ python setup.py install
# OR
$ pip install -r requirements.txt
```

Or you can install via pip using the Zip archive autogenerated by Github:

```
$ pip install https://github.com/arquivei/superflux/archive/master.zip
```

Configuring Superflux
---------------------

Superflux should run as a [Supervisor Event Listener][supervisor_events]. The simplest
configuration that makes that work is this:

```
[eventlistener:superflux]
command=superflux --influx-server=influx.server --influx-port=8806 --influx-group=identifier
events=PROCESS_STATE
numprocs=1
```

Superflux Options
-----------------

You can get a list of the supported options for Superflux by running it with -h:

```
$ Superflux -h
Usage: superflux [options]

Options:
  -h, --help            show this help message and exit
  -s INFLUX_SERVER, --influx-server=INFLUX_SERVER
                        InfluxDB server address
  -p INFLUX_PORT, --influx-port=INFLUX_PORT
                        InfluxDB server port
  -P INFLUX_DB, --influx-db=INFLUX_DB
                        Which DB to write to
  -S INFLUX_GROUP, --influx-group=INFLUX_GROUP
                        Extra attribute to group metrics
  -d, --debug           Enable debug output to STDERR
```

When configuring Superflux, you may want to supply the --debug option to
see what it's doing and then remove it when you run in production.

Superflux Library
-----------------

You can use Superflux as a library as well and wrap your own logic around
it's methods. It follows the convention of Python libraries and all the
CLI options can be passed to the constructor.

```python
import Superflux

object = Superflux( ... )
```

Superflux Events
---------------

Superflux will generate influx events for every 'PROCESS_STATE' change that
is emitted by Supervisor. For example, if you start Superflux with these options:

```
Superflux --influx-server=influx.example.com --influx-port=8806 --influx-group=`my_group`
```

And you were to restart the 'sample_service' managed by Supervisor, this is what
would be sent to influx:

```
process_state, group=my_group, name=sample_service, from_state=running, to_state=stopping, value=1
process_state, group=my_group, name=sample_service, from_state=stopping, to_state=stopped, value=1
process_state, group=my_group, name=sample_service, from_state=stopped, to_state=starting, value=1
process_state, group=my_group, name=sample_service, from_state=starting, to_state=running, value=1
```

This also shows that a Supervisor restart is 4 distinct events:
* running -> stopping
* stopping -> stopped
* stopped -> starting
* starting -> started


[supervisor]: https://github.com/Supervisor/supervisor
[supervisor_events]: http://supervisord.org/events.html
[influxdb]: https://github.com/influxdata/influxdb
